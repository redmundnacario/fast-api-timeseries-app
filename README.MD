# Observation Time Series REST API
- FastAPI, PostgreSQL

## Backend Requirements

* Pyenv for selecting and installing specific python version
* Python v3.11
* [Poetry](https://python-poetry.org/) for Python package and environment management.
* [Docker](https://www.docker.com/).
* [Docker Compose](https://docs.docker.com/compose/install/).

## Environment variables
  
Check backend/sample.env and fill the needed variables except host and port.
Most of the variables are needed for PostgreSQL Database setup.

```
DB_NAME=
DB_USERNAME=
DB_PASSWORD=
DB_HOST=postgres
DB_PORT=5432
APP_VERSION=
```


## Backend local development

* Start the stack with Docker Compose:

```bash
cd backend
docker-compose -f local.yml build
docker-compose -f local.yml up
```

* Now you can open your browser and interact with these URLs:


Backend, JSON based web API based on OpenAPI: http://localhost:8000/

Automatic interactive documentation with Swagger UI (from the OpenAPI backend): http://localhost:8000/docs

Alternative automatic documentation with ReDoc (from the OpenAPI backend): http://localhost:8000/redoc

DB connection :  `Check your postgresql url created from your DB`


**Note**: The first time you start your stack, it might take a minute for it to be ready. While the backend waits for the database to be ready and configures everything. You can check the logs to monitor it.

To check the logs, run:

```bash
docker-compose -f local.yml logs
```

To check the logs of a specific service, add the name of the service, e.g.:

```bash
docker-compose -f local.yml logs backend
```

Start an interactive session in the backend container:

```console
$ docker-compose exec backend bash
```

### General workflow

By default, the dependencies are managed with [Poetry](https://python-poetry.org/), go there and install it.

From `/backend` you can install all the dependencies with:

```console
$ poetry install
```

Then you can start a shell session with the new environment with:

```console
$ poetry shell
```

Next, open your editor at `./backend` and activate environment 
`source venv/bin/activate` so that you can add new libraries thru poetry later.
Adding libraries: `poetry add  <name-of-python-library`. Always update the requirements.txt
afterwards: `pip freeze > requirements.txt`

Modify or add SQLAlchemy models in `./backend/db/models/`, Pydantic schemas in `./backend/pydantic_schemas/`, API endpoints in `./backend/routes/`, Controllers in `./backend/controllers/`.

### Backend tests

To test the backend run:

```console
cd backend
pytest
```

Modify and add tests to `./backend/tests/`.

### Migrations

* After changing a model (for example, adding a column), inside the container, create a revision, e.g.:

```console
$ alembic revision --autogenerate -m "Add column last_name to User model"
```

* After creating the revision, run the migration in the database (this is what will actually change the database):

```console
$ alembic upgrade head
```

## URLs

These are the URLs that will be used and generated by the project.

## License

MIT license @ [author](author.com)